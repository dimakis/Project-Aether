# =============================================================================
# Test Environment Docker Compose
# =============================================================================
# Constitution: Reliability & Quality
# Provides isolated services for integration and E2E tests.
#
# Usage:
#   podman-compose -f infrastructure/test/docker-compose.test.yaml up -d
#   pytest tests/integration tests/e2e
#   podman-compose -f infrastructure/test/docker-compose.test.yaml down -v

services:
  # ===========================================================================
  # PostgreSQL - Test Database
  # ===========================================================================
  postgres-test:
    image: postgres:16-alpine
    container_name: aether-postgres-test
    environment:
      POSTGRES_USER: test
      POSTGRES_PASSWORD: test
      POSTGRES_DB: aether_test
    ports:
      - "5433:5432"  # Different port to avoid conflicts
    volumes:
      - postgres-test-data:/var/lib/postgresql/data
      - ../postgres/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U test -d aether_test"]
      interval: 5s
      timeout: 5s
      retries: 5
    networks:
      - aether-test-network

  # ===========================================================================
  # MLflow - Test Tracking Server
  # ===========================================================================
  mlflow-test:
    image: ghcr.io/mlflow/mlflow:v2.18.0
    container_name: aether-mlflow-test
    command: >
      mlflow server
      --host 0.0.0.0
      --port 5000
      --backend-store-uri sqlite:///mlflow.db
      --default-artifact-root /mlflow/artifacts
    ports:
      - "5001:5000"  # Different port to avoid conflicts
    volumes:
      - mlflow-test-data:/mlflow
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - aether-test-network

  # ===========================================================================
  # Mock Home Assistant (for E2E tests)
  # ===========================================================================
  # Note: This is a simple mock server, not actual HA
  mock-ha:
    image: python:3.11-slim
    container_name: aether-mock-ha
    working_dir: /app
    command: >
      python -c "
      from http.server import HTTPServer, BaseHTTPRequestHandler
      import json

      class Handler(BaseHTTPRequestHandler):
          def do_GET(self):
              if self.path == '/api/':
                  self.send_response(200)
                  self.send_header('Content-Type', 'application/json')
                  self.end_headers()
                  self.wfile.write(json.dumps({'message': 'API running'}).encode())
              elif self.path == '/api/states':
                  self.send_response(200)
                  self.send_header('Content-Type', 'application/json')
                  self.end_headers()
                  self.wfile.write(json.dumps([]).encode())
              else:
                  self.send_response(404)
                  self.end_headers()

          def log_message(self, format, *args):
              pass

      HTTPServer(('0.0.0.0', 8123), Handler).serve_forever()
      "
    ports:
      - "8124:8123"  # Different port to avoid conflicts
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8123/api/"]
      interval: 5s
      timeout: 5s
      retries: 3
    networks:
      - aether-test-network

networks:
  aether-test-network:
    driver: bridge

volumes:
  postgres-test-data:
  mlflow-test-data:
